## 1. 项目结构和依赖

- [ ] 1.1 创建 `pkg/memory/` 包目录结构
- [ ] 1.2 添加依赖到 `go.mod`：hnswgo, go-tokenizer
- [ ] 1.3 定义 `MemoryEntry` 数据结构在 `entry.go`
- [ ] 1.4 定义 `MemoryHub` 接口在 `memory.go`
- [ ] 1.5 定义配置结构 `MemoryConfig` 在 `config/config.go`

## 2. 分层存储实现

- [ ] 2.1 实现 `MemoryStorage` 接口在 `storage.go`
- [ ] 2.2 实现 L1 LRU 缓存 `L1Cache` 结构
- [ ] 2.3 实现 L2 Badger 存储 `L2Badger` 结构
- [ ] 2.4 实现 L3 向量数据库适配器 `L3VectorDB` 结构（可选）
- [ ] 2.5 实现分层存储协调逻辑（L1 -> L2 -> L3 查询链）
- [ ] 2.6 实现缓存提升逻辑（L2/L3 命中后提升到 L1）
- [ ] 2.7 实现 Session 级别的 key 前缀管理
- [ ] 2.8 编写存储层单元测试

## 3. 向量检索实现

- [ ] 3.1 创建 `vector.go` 实现向量检索
- [ ] 3.2 初始化 HNSW 索引，支持配置维度和距离度量
- [ ] 3.3 实现向量添加到索引 `AddVector()`
- [ ] 3.4 实现向量更新和删除 `UpdateVector()`, `DeleteVector()`
- [ ] 3.5 实现近似最近邻搜索 `Search()`
- [ ] 3.6 实现余弦相似度计算
- [ ] 3.7 实现向量维度验证
- [ ] 3.8 实现 Session 级别的向量过滤
- [ ] 3.9 实现索引持久化（保存/加载）
- [ ] 3.10 编写向量检索单元测试
- [ ] 3.11 编写向量检索性能基准测试

## 4. BM25 全文检索实现

- [ ] 4.1 创建 `bm25.go` 实现 BM25 检索
- [ ] 4.2 实现文本分词器 `Tokenizer`（支持中英文）
- [ ] 4.3 实现文档索引 `IndexDocument()`
- [ ] 4.4 实现 IDF 计算和更新
- [ ] 4.5 实现平均文档长度跟踪
- [ ] 4.6 实现 BM25 评分公式
- [ ] 4.7 实现 Top-K 搜索 `Search()`
- [ ] 4.8 实现 Session 级别的文档过滤
- [ ] 4.9 实现停用词过滤（可选）
- [ ] 4.10 实现文档更新和删除
- [ ] 4.11 编写 BM25 单元测试
- [ ] 4.12 编写 BM25 性能基准测试

## 5. 混合检索实现

- [ ] 5.1 创建 `hybrid.go` 实现混合检索
- [ ] 5.2 实现并行执行向量检索和 BM25 搜索
- [ ] 5.3 实现 RRF (Reciprocal Rank Fusion) 融合算法
- [ ] 5.4 实现结果去重逻辑
- [ ] 5.5 实现可配置的检索权重（向量/BM25）
- [ ] 5.6 实现查询模式选择（vector-only/BM25-only/hybrid）
- [ ] 5.7 实现 Top-K 结果限制
- [ ] 5.8 实现元数据过滤
- [ ] 5.9 实现错误处理（一个检索器失败时的降级）
- [ ] 5.10 编写混合检索单元测试
- [ ] 5.11 编写混合检索集成测试

## 6. FSRS-6 记忆衰减实现

- [ ] 6.1 创建 `fsrs.go` 实现记忆衰减
- [ ] 6.2 实现 FSRS-6 强度计算公式 `UpdateStrength()`
- [ ] 6.3 实现稳定性参数管理
- [ ] 6.4 实现后台衰减 Goroutine `StartDecayLoop()`
- [ ] 6.5 实现批量衰减处理
- [ ] 6.6 实现遗忘阈值检查和自动删除
- [ ] 6.7 实现手动强度提升 `BoostStrength()`
- [ ] 6.8 实现 Session 级别的衰减隔离
- [ ] 6.9 实现优雅关闭逻辑
- [ ] 6.10 实现衰减指标暴露
- [ ] 6.11 编写 FSRS-6 单元测试
- [ ] 6.12 编写衰减性能测试

## 7. Memory Hub API 实现

- [ ] 7.1 实现 `MemoryHub` 结构体在 `memory.go`
- [ ] 7.2 实现 `Memorize()` 方法
- [ ] 7.3 实现 `Retrieve()` 方法
- [ ] 7.4 实现 `Forget()` 方法
- [ ] 7.5 实现 `ForgetByThreshold()` 方法
- [ ] 7.6 实现 `List()` 方法（支持分页）
- [ ] 7.7 实现 `Count()` 方法
- [ ] 7.8 实现 `GetStats()` 方法
- [ ] 7.9 实现 `DeleteSession()` 方法
- [ ] 7.10 实现 `BatchMemorize()` 方法
- [ ] 7.11 实现并发安全保护（互斥锁）
- [ ] 7.12 实现错误处理和验证
- [ ] 7.13 编写 Memory Hub 单元测试
- [ ] 7.14 编写 Memory Hub 集成测试

## 8. 配置集成

- [ ] 8.1 在 `config/config.go` 添加 `MemoryConfig` 结构
- [ ] 8.2 添加 `enabled` 配置项（默认 false）
- [ ] 8.3 添加向量维度配置（默认 768）
- [ ] 8.4 添加检索权重配置（向量 0.7, BM25 0.3）
- [ ] 8.5 添加 L1 缓存大小配置（默认 1000）
- [ ] 8.6 添加遗忘阈值配置（默认 0.1）
- [ ] 8.7 添加衰减间隔配置（默认 1 小时）
- [ ] 8.8 添加 FSRS-6 参数配置（stability, k1, b）
- [ ] 8.9 添加向量数据库配置（可选）
- [ ] 8.10 更新 `config.example.yaml` 添加 memory 配置段
- [ ] 8.11 添加配置验证规则
- [ ] 8.12 编写配置加载测试

## 9. Engine 集成

- [ ] 9.1 在 `pkg/engine/engine.go` 添加 `memoryHub` 字段
- [ ] 9.2 在 `New()` 中初始化 Memory Hub（如果启用）
- [ ] 9.3 在 `Start()` 中启动 Memory Hub 和衰减循环
- [ ] 9.4 在 `Stop()` 中优雅关闭 Memory Hub
- [ ] 9.5 提供 `GetMemoryHub()` 方法供外部访问
- [ ] 9.6 添加 Memory Hub 初始化日志
- [ ] 9.7 测试 Engine 与 Memory Hub 集成

## 10. HTTP API 端点

- [ ] 10.1 创建 `pkg/api/handlers/memory.go`
- [ ] 10.2 实现 `POST /api/v1/memory/{sessionID}` 存储记忆
- [ ] 10.3 实现 `GET /api/v1/memory/{sessionID}` 查询记忆
- [ ] 10.4 实现 `DELETE /api/v1/memory/{sessionID}` 删除记忆
- [ ] 10.5 实现 `GET /api/v1/memory/{sessionID}/list` 列出记忆
- [ ] 10.6 实现 `GET /api/v1/memory/{sessionID}/stats` 获取统计
- [ ] 10.7 实现 `DELETE /api/v1/memory/{sessionID}/all` 删除会话
- [ ] 10.8 实现 `DELETE /api/v1/memory/{sessionID}/weak` 删除弱记忆
- [ ] 10.9 在 `pkg/api/router.go` 注册记忆路由
- [ ] 10.10 添加请求验证和错误处理
- [ ] 10.11 编写 API 端点单元测试
- [ ] 10.12 编写 API 端点集成测试

## 11. 主程序集成

- [ ] 11.1 在 `cmd/goclaw/main.go` 初始化 Memory Hub
- [ ] 11.2 传递 Memory Hub 到 Engine
- [ ] 11.3 传递 Memory Hub 到 API Server
- [ ] 11.4 在 shutdown 时优雅关闭 Memory Hub
- [ ] 11.5 添加 Memory Hub 启动日志
- [ ] 11.6 测试完整启动和关闭流程

## 12. 文档

- [ ] 12.1 创建 `docs/memory-system-guide.md` 使用指南
- [ ] 12.2 文档化所有 Memory Hub API 方法
- [ ] 12.3 文档化配置选项和默认值
- [ ] 12.4 添加 API 端点使用示例
- [ ] 12.5 添加向量化最佳实践
- [ ] 12.6 添加性能调优指南
- [ ] 12.7 添加故障排查指南
- [ ] 12.8 更新 `README.md` 添加记忆系统说明
- [ ] 12.9 更新 `CLAUDE.md` 添加 memory 架构说明
- [ ] 12.10 生成 Swagger 文档（记忆 API）

## 13. 测试

- [ ] 13.1 编写 MemoryEntry 序列化/反序列化测试
- [ ] 13.2 编写分层存储集成测试
- [ ] 13.3 编写向量检索准确性测试
- [ ] 13.4 编写 BM25 检索准确性测试
- [ ] 13.5 编写混合检索融合测试
- [ ] 13.6 编写 FSRS-6 衰减计算测试
- [ ] 13.7 编写并发安全测试
- [ ] 13.8 编写 Session 隔离测试
- [ ] 13.9 编写端到端集成测试
- [ ] 13.10 编写性能基准测试（100K 条目）
- [ ] 13.11 编写内存占用测试
- [ ] 13.12 运行完整测试套件确认无回归

## 14. 性能优化

- [ ] 14.1 优化向量检索性能（批量操作）
- [ ] 14.2 优化 BM25 索引更新性能
- [ ] 14.3 优化 L1 缓存命中率
- [ ] 14.4 优化衰减批处理大小
- [ ] 14.5 添加性能监控指标
- [ ] 14.6 基准测试检索延迟（目标 <20ms）
- [ ] 14.7 基准测试内存占用（目标 <100MB for 10K entries）
- [ ] 14.8 优化并发性能（锁粒度）

## 15. 清理和验收

- [ ] 15.1 运行 `go fmt` 格式化代码
- [ ] 15.2 运行 `go vet` 检查问题
- [ ] 15.3 运行 `golangci-lint` 检查代码质量
- [ ] 15.4 修复所有 lint 警告
- [ ] 15.5 更新 go.mod 和 go.sum
- [ ] 15.6 运行完整测试套件（单元+集成+性能）
- [ ] 15.7 验证测试覆盖率 > 80%
- [ ] 15.8 验证所有 API 端点可访问
- [ ] 15.9 验证配置文件示例完整
- [ ] 15.10 验证文档完整性

## 验收标准

完成所有任务后，验证以下标准：

### 功能性
- [ ] Memory Hub API 所有方法正常工作
- [ ] 向量检索返回正确的相似结果
- [ ] BM25 检索返回正确的匹配结果
- [ ] 混合检索正确融合两种结果
- [ ] FSRS-6 衰减正确更新记忆强度
- [ ] Session 隔离正常工作
- [ ] HTTP API 端点正常响应

### 质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有集成测试通过
- [ ] 所有性能测试通过
- [ ] 无已知严重 bug
- [ ] 代码通过 lint 检查

### 性能
- [ ] 向量检索延迟 < 10ms (100K 条目)
- [ ] BM25 检索延迟 < 10ms (100K 条目)
- [ ] 混合检索延迟 < 20ms (100K 条目)
- [ ] 内存占用 < 100MB (10K 条目)
- [ ] L1 缓存命中率 > 80%

### 文档
- [ ] 使用指南完整
- [ ] API 文档完整
- [ ] 配置说明清晰
- [ ] 示例代码可运行
- [ ] 故障排查指南可用

## 估算

- **阶段 1-2**: 项目结构和分层存储 - 2 天
- **阶段 3-4**: 向量检索和 BM25 - 3 天
- **阶段 5-6**: 混合检索和记忆衰减 - 2 天
- **阶段 7-8**: Memory Hub API 和配置 - 2 天
- **阶段 9-11**: Engine 和 API 集成 - 2 天
- **阶段 12-13**: 文档和测试 - 2 天
- **阶段 14-15**: 性能优化和验收 - 1 天

**总计**: 约 14 天

## 注意事项

1. **按顺序实现**: 先存储层，再检索层，最后 API 层
2. **测试驱动**: 为每个模块编写测试
3. **增量提交**: 完成每个阶段后提交代码
4. **性能监控**: 持续监控内存和延迟
5. **向后兼容**: 记忆系统默认禁用，不影响现有功能
6. **文档同步**: 代码和文档同步更新
7. **依赖管理**: 优先使用纯 Go 实现，避免 CGO
8. **错误处理**: 所有外部调用都要有错误处理
