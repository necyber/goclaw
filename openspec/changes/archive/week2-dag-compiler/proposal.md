---
status: archived
priority: high
assignee: "@dev"
created: 2026-02-23
---

# Week 2: DAG 编译器

## 背景与动机

Goclaw 的核心功能是多 Agent 编排，其基础是任务依赖图（DAG, Directed Acyclic Graph）。为了正确、高效地执行任务，我们需要一个强大的 DAG 编译器来处理：

1. **任务依赖解析** - 解析任务之间的依赖关系
2. **环检测** - 防止循环依赖导致死锁
3. **拓扑排序** - 确定任务执行顺序
4. **并行分析** - 识别可并行执行的任务组
5. **执行计划生成** - 生成可执行的分层计划

## 目标

构建完整的 DAG 编译器模块：
- 任务定义 DSL 和图结构表示
- 环检测算法（DFS）
- 拓扑排序（Kahn's Algorithm）
- 执行计划生成（分层、并行组、关键路径）
- 丰富的错误信息（指出循环依赖位置）

## 非目标

- 动态 DAG 修改（运行时添加/删除任务）
- 条件分支和循环（Workflow 控制流）
- 分布式 DAG 存储（Phase 2）

## 成功标准

- [ ] 支持定义任务和依赖关系
- [ ] 环检测时间复杂度 O(V+E)
- [ ] 拓扑排序时间复杂度 O(V+E)
- [ ] 循环依赖错误信息指出具体路径
- [ ] 识别最大并行度
- [ ] 单元测试覆盖率 > 85%

## 影响范围

- 新建 `pkg/dag` 包（Week 2 DAG-core 核心范围）
- Workflow 定义接口（Deferred：后续变更，不属于 Week 2 DAG-core）
- 调度器集成（Deferred：后续变更，不属于 Week 2 DAG-core）

## 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 复杂 DAG 性能问题 | 低 | 中 | 使用高效算法，基准测试 |
| 错误信息不够清晰 | 中 | 中 | 设计专门的错误类型 |

## Errata 记录格式（仅用于非语义修复）

当仅修复编码、错别字、失效链接等非语义问题时，使用如下格式追加记录：

`[Errata YYYY-MM-DD] Type=<encoding|typo|link> Reason=<原因> Scope=<影响段落/文件>`
