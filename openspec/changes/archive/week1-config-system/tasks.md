# Week 1: 配置系统 - 任务清单

## 1. 项目基础设施

### 1.1 配置结构定义
- [ ] 创建 `config/config.go`，定义全局 Config 结构体
- [ ] 定义 `AppConfig` 结构体（name, version, environment, debug）
- [ ] 定义 `ServerConfig` 结构体（host, port, grpc, http）
- [ ] 定义 `LogConfig` 结构体（level, format, output）
- [ ] 定义 `OrchestrationConfig` 结构体（max_agents, queue_size, scheduler）
- [ ] 定义 `StorageConfig` 结构体（type, redis 等）
- [ ] 定义 `MetricsConfig` 结构体（enabled, path, port）

### 1.2 配置加载器
- [ ] 添加 Koanf 依赖到 go.mod
- [ ] 创建 `config/loader.go` 实现配置加载
- [ ] 实现从 YAML 文件加载
- [ ] 实现从 JSON 文件加载
- [ ] 实现环境变量覆盖（GOCLAW_* 前缀）
- [ ] 实现 CLI 参数解析集成
- [ ] 实现配置合并逻辑（按优先级）

### 1.3 配置验证
- [ ] 添加 validator 依赖
- [ ] 创建 `config/validator.go` 实现验证逻辑
- [ ] 实现 struct tag 验证（required, min, max, oneof）
- [ ] 实现自定义验证器（端口号范围、文件路径存在性）
- [ ] 实现友好的错误信息格式化

### 1.4 默认值管理
- [ ] 创建 `config/defaults.go` 定义所有默认值
- [ ] 实现默认值注入机制
- [ ] 确保默认值覆盖所有可选配置项

## 2. 日志系统

### 2.1 日志接口设计
- [ ] 创建 `pkg/logger/logger.go` 定义 Logger 接口
- [ ] 定义日志级别常量（Debug, Info, Warn, Error）
- [ ] 定义日志字段类型

### 2.2 slog 实现
- [ ] 创建 `pkg/logger/slog.go` 实现 slog 适配器
- [ ] 实现 JSON 格式输出
- [ ] 实现 Text 格式输出
- [ ] 实现文件输出支持
- [ ] 实现异步日志（可选）

### 2.3 日志配置集成
- [ ] 实现从 Config 创建 Logger
- [ ] 实现全局默认 Logger
- [ ] 实现上下文注入 Logger

### 2.4 日志增强
- [ ] 添加调用者信息（file:line）
- [ ] 添加上下文字段支持
- [ ] 实现采样日志（高频率日志抑制）

## 3. 配置热重载

### 3.1 文件监控
- [ ] 创建 `config/watcher.go` 实现文件监控
- [ ] 使用 fsnotify 监听配置文件变化
- [ ] 实现防抖机制（避免频繁触发）

### 3.2 动态更新
- [ ] 实现日志级别热更新
- [ ] 实现日志格式热更新
- [ ] 设计回调机制供其他模块订阅配置变化

## 4. 测试

### 4.1 单元测试
- [ ] 测试配置结构体序列化/反序列化
- [ ] 测试配置验证逻辑
- [ ] 测试配置加载优先级
- [ ] 测试日志输出格式
- [ ] 测试热重载触发

### 4.2 集成测试
- [ ] 测试完整加载流程（文件→环境变量→验证）
- [ ] 测试无效配置的优雅失败
- [ ] 测试多配置文件场景

## 5. 文档与示例

### 5.1 配置示例
- [ ] 更新 `config/config.example.yaml`
- [ ] 创建 `config/config.example.json`
- [ ] 创建 `.env.example` 环境变量示例

### 5.2 文档
- [ ] 编写配置系统使用文档
- [ ] 更新 README.md 配置部分
- [ ] 添加配置项说明注释

## 6. 集成到主程序

### 6.1 启动流程集成
- [ ] 修改 `cmd/goclaw/main.go` 使用新配置系统
- [ ] 实现配置加载失败时的优雅退出
- [ ] 添加 `--config` 参数支持自定义配置文件路径

### 6.2 验证
- [ ] 完整启动流程测试
- [ ] 无效配置错误提示测试
- [ ] 配置文件热重载测试

---

## 任务优先级

| 任务 | 优先级 | 依赖 |
|------|--------|------|
| 1.1 配置结构定义 | P0 | 无 |
| 1.2 配置加载器 | P0 | 1.1 |
| 1.3 配置验证 | P0 | 1.1, 1.2 |
| 2.1-2.2 日志系统 | P0 | 1.1 |
| 6.1 启动流程集成 | P0 | 1.x, 2.x |
| 4.1 单元测试 | P1 | 1.x, 2.x |
| 3.x 热重载 | P2 | 1.x, 2.x |
| 4.2 集成测试 | P2 | 全部 |
| 5.x 文档 | P2 | 全部 |

## 预估工作量

- 配置结构定义：2h
- 配置加载器：4h
- 配置验证：3h
- 日志系统：4h
- 热重载：3h
- 测试：4h
- 文档：2h
- **总计：约 22 小时**
